<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hành Trình Huyền Bí</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="tarot_data.js" defer></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Spectral:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        @font-face {
          font-family: 'KD Hidayatullah v2';
          src: url('/assets/fonts/KD-Hidayatullah-v2.ttf') format('truetype'); /* [ĐÃ SỬA] Đường dẫn tuyệt đối */
          font-weight: 400;
          font-style: normal;
          font-display: swap; 
        }

        h1, h2, h3, h4, h5, h6, .button-area button, .ai-reading-actions button {
            font-family: 'KD Hidayatullah v2', 'Cinzel', serif;
            font-weight: 700; 
        }

        body {
            font-family: 'Spectral', serif; 
            background: linear-gradient(135deg, #000000 0%, #030629 35%, #001f3a 100%);
            color: #e0e0e0; 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .app-container {
            background-color: rgba(10, 15, 30, 0.85); 
            border-radius: 1.5rem; 
            box-shadow: 0 10px 35px rgba(0, 191, 255, 0.1); 
            border: 1px solid rgba(0, 191, 255, 0.3); 
            padding: 2rem;
            width: 100%;
            max-width: 850px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            backdrop-filter: blur(5px);
        }
        
        .card-display-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
            perspective: 1000px;
        }
        
        .card {
            width: 180px;
            height: 300px;
            background-color: #030629;
            border-radius: 0.75rem; 
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.2);
            border: 3px solid #00bfff;
            overflow: hidden; 
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.drawn {
            transform: rotateY(180deg);
        }

        .card-image-back, .card-image-front {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
            position: absolute;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-image-front {
            transform: rotateY(180deg);
        }

        .current-spread-display {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            align-items: flex-start; 
            min-height: 180px; 
            width: 100%;
            margin-top: 0.5rem;
            flex-wrap: wrap; 
        }
        .current-spread-card {
            width: calc(33.33% - 0.5rem);
            max-width: 110px; 
            height: 180px;
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid #007b9e;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .current-spread-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 191, 255, 0.3);
        }
        .current-spread-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .card-name-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: #00bfff;
            padding: 4px 2px;
            font-size: 0.65rem;
            line-height: 1.2;
            font-family: 'Spectral', serif;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        @media (max-width: 640px) {
            .app-container { padding: 1rem; }
            .card { width: 150px; height: 250px; }
            .current-spread-card { width: calc(50% - 0.375rem); max-width: 140px; height: 220px; }
        }

        .button-area {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .button-area button {
            background-color: #007b9e;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 9999px; 
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #00bfff;
            box-shadow: 0 5px 15px rgba(0, 191, 255, 0.2); 
        }
        .button-area button:hover:not(:disabled) {
            background-color: #00bfff;
            color: #030629;
            border-color: #00bfff;
            transform: translateY(-2px); 
        }
        .button-area button:disabled {
            background-color: #4a4a4a;
            color: #888;
            border-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .ai-reading-area {
            background-color: rgba(3, 6, 41, 0.9);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 0.5rem;
            width: 100%;
            border: 1px solid #007b9e;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        textarea#question-input {
            background-color: #030629;
            color: #e0e0e0;
            border: 1px solid #007b9e;
            font-family: 'Spectral', serif;
        }
        textarea#question-input::placeholder {
            color: #007b9e;
            font-style: italic;
        }
        .ai-reading-actions {
            display: flex;
            flex-wrap: wrap; 
            gap: 0.75rem; 
            margin-top: 1rem;
            justify-content: center;
        }
        .ai-reading-actions button {
            padding: 0.6rem 1.2rem;
            border-radius: 9999px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid;
        }
        .ai-reading-actions .primary-btn {
            background-color: #00bfff;
            color: #030629;
            border-color: #00bfff;
        }
        .ai-reading-actions .primary-btn:hover:not(:disabled) {
            background-color: #009acd;
            transform: scale(1.05);
        }
        .ai-reading-actions .secondary-btn {
            background-color: #007b9e;
            color: white;
            border-color: #00bfff;
        }
        .ai-reading-actions .secondary-btn:hover:not(:disabled) {
            background-color: #005f7c;
            transform: scale(1.05);
        }
        .ai-reading-actions .reset-btn {
            background-color: #c0392b;
            color: white;
            border-color: #e74c3c;
        }
        .ai-reading-actions .reset-btn:hover:not(:disabled) {
            background-color: #e74c3c;
            transform: scale(1.05);
        }
        .ai-reading-actions button:disabled {
            background-color: #4a4a4a;
            color: #888;
            border-color: #555;
            cursor: not-allowed;
            transform: none;
        }
        .ai-response.loading {
            text-align: center;
            font-style: italic;
            color: #00bfff;
            padding: 1rem;
        }

        /* Message Box */
        .message-box {
            background-color: #007b9e; 
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 1rem;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 80%;
            font-family: 'Spectral', serif;
        }
        .message-box.show { opacity: 1; transform: translateY(0); }
        .message-box.bg-red-500 { background-color: #c0392b; }
        .message-box.bg-green-500 { background-color: #27ae60; }
        .message-box.bg-blue-500 { background-color: #007b9e; }

        /* History */
        .history-container {
            width: 100%;
            max-height: 350px; 
            overflow-y: auto; 
            border: 1px solid #007b9e;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: #030629;
        }
        .history-spread-group {
            border: 1px solid #005f7c;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            background-color: #0a0f1e;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .history-spread-cards {
            display: flex;
            flex-wrap: wrap; 
            gap: 0.5rem; 
            justify-content: center;
        }
        .history-card-item {
            width: calc(25% - 0.4rem);
            max-width: 70px;
            height: 110px;
            border-radius: 0.5rem;
            border: 1px solid #007b9e;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .history-card-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(0, 191, 255, 0.3);
        }
        .history-card-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .history-card-item .card-name-overlay {
            font-size: 0.55rem;
            color: #00bfff;
        }
        .selection-area {
            background-color: rgba(3, 6, 41, 0.9);
            border: 1px solid #007b9e;
        }
        .selection-area h3 {
            color: #cceeff;
        }
        .radio-group label {
            color: #b3e6ff;
            cursor: pointer;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 1.5rem; 
        }
        #clear-history-button {
            background: #c0392b;
            color: white;
            border: 1px solid #e74c3c;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 9999px;
            font-family: 'Spectral', serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        #clear-history-button:hover {
            background: #e74c3c;
            transform: scale(1.05);
        }

        /* Modal Xem Lá Bài */
        #card-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #card-modal-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }
        #card-modal-content {
            background: #0a0f1e;
            border: 2px solid #00bfff;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 191, 255, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            width: 90%;
            max-width: 800px; 
            text-align: left; 
            position: relative; 
        }
        #modal-card-image {
            width: 250px; 
            height: 417px;
            object-fit: cover;
            border-radius: 0.75rem;
            border: 2px solid #007b9e;
            flex-shrink: 0; 
        }
        #modal-card-name {
            font-size: 1.5rem;
            color: #00bfff;
            margin-top: 1rem;
            text-align: center; 
        }
        
        #modal-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2.5rem;
            color: #00bfff;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            font-family: 'Spectral', serif;
            font-weight: bold;
        }

        .modal-meaning-content {
            flex-grow: 1; 
            max-height: 417px; 
            overflow-y: auto;
            padding-right: 10px; 
        }
        .modal-meaning-content h4 {
            font-size: 1.2rem;
            border-bottom: 1px solid #007b9e;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }
        .modal-meaning-content p {
            font-family: 'Spectral', serif;
            color: #e0e0e0;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            white-space: pre-line; 
        }
        .modal-meaning-content::-webkit-scrollbar { width: 5px; }
        .modal-meaning-content::-webkit-scrollbar-track { background: #030629; }
        .modal-meaning-content::-webkit-scrollbar-thumb { background: #007b9e; border-radius: 5px; }

    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="text-3xl font-extrabold text-gray-100 mb-4 text-center">Giải mã thông điệp vũ trụ</h1>
        <p class="text-gray-300 text-center text-lg">Chọn một lá bài. Đặt một câu hỏi. Và lắng nghe lời thì thầm của định mệnh.</p>

        <div class="selection-area w-full p-4 rounded-lg shadow-sm">
            <h3 class="font-bold text-gray-200 mb-2 text-center text-xl">Chọn một hành trình</h3>
            <div class="radio-group flex flex-wrap gap-x-4 gap-y-2 mb-4 justify-center text-base">
                <label><input type="radio" name="spread-type" value="1" checked> Một lá bài cho ngày mới</label>
                <label><input type="radio" name="spread-type" value="3"> Ba lá bài (Quá khứ - Hiện tại - Tương lai)</label>
                <label><input type="radio" name="spread-type" value="5"> Năm lá bài khai mở vấn đề</label>
            </div>
        </div>

        <div class="card-display-area">
            <div id="current-card" class="card">
                <img id="card-image-back" class="card-image-back" src="/assets/images/tarot/cardback.jpg" alt="Mặt sau lá bài Tarot">
                <img id="card-image-front" class="card-image-front" src="" alt="Lá bài Tarot đã bóc">
            </div>
        </div>

        <div id="current-spread-display" class="current-spread-display"></div>

        <div class="button-area">
            <button id="draw-button">Rút một lá bài</button>
            <button id="complete-spread-button" disabled>Hoàn tất trải bài</button>
        </div>
        <div class="message-box" id="message-box"></div>

        <div class="ai-reading-area">
            <h3 class="text-lg font-bold text-gray-200 mb-2 text-center">Bước 2: Kết nối với tiềm thức</h3>
            <textarea id="question-input" placeholder="Nhập điều bạn đang trăn trở..." class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" rows="3"></textarea>

            <div class="ai-reading-actions">
                <button id="get-ai-reading-button" disabled class="primary-btn">Lắng nghe lời giải</button>
                <button id="coi-sau-them-btn" disabled class="secondary-btn">Hỏi sâu hơn</button>
                <button id="boc-bai-moi-btn" disabled class="reset-btn">Bắt đầu vòng gieo mới</button>
            </div>

            <div id="ai-response-display" class="mt-4">
                <div id="loading-ai-response" class="ai-response loading hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Các đấng tối cao đang luận giải...
                </div>

                <div id="ai-card-interpretations-container" class="mt-4 hidden p-4 border rounded-lg">
                    <h4 class="text-md font-bold mb-3 text-center">Giải thích năng lượng từng lá bài:</h4>
                    <div id="ai-card-interpretations-row" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
                </div>

                <div id="ai-overall-interpretation" class="mt-4 hidden p-4 border rounded-lg">
                    <h4 class="text-md font-bold mb-2 text-center">Thông điệp tổng quan:</h4>
                    <p id="overall-text" class="text-gray-200"></p>
                </div>
                <div id="ai-suggestions" class="mt-4 hidden p-4 border rounded-lg">
                    <h4 class="text-md font-bold mb-2 text-center">Gợi ý từ vũ trụ:</h4>
                    <p id="suggestions-text" class="text-gray-200"></p>
                </div>
            </div>
        </div>

        <div class="history-header">
            <h2 class="text-xl font-bold text-gray-200">Nhật ký hành trình</h2>
            <button id="clear-history-button">Xóa Lịch Sử</button>
        </div>
        <div id="history-container" class="history-container"></div>
    </div>

    <div id="card-modal-backdrop" class="hidden">
        <div id="card-modal-content">
            <div class="flex-shrink-0">
                <img id="modal-card-image" src="" alt="Lá bài Tarot" />
                <h3 id="modal-card-name">Tên Lá Bài</h3>
            </div>
            <div class="modal-meaning-content">
                <div><h4 style="color: #00bfff;">Từ khóa</h4><p id="modal-card-keywords"></p></div>
                <div><h4 style="color: #27ae60;">Ý nghĩa Xuôi</h4><p id="modal-card-xuoi"></p></div>
                <div><h4 style="color: #f39c12;">Ý nghĩa Ngược</h4><p id="modal-card-nguoc"></p></div>
            </div>
            <button id="modal-close-button">&times;</button>
        </div>
    </div>

    <script>
        const allTarotCards = [
            "0 - The Fool", "I - The Magician", "II - The High Priestess", "III - The Empress",
            "IV - The Emperor", "V - The Hierophant", "VI - The Lovers", "VII - The Chariot",
            "VIII - Strength", "IX - The Hermit", "X - Wheel of Fortune", "XI - Justice",
            "XII - The Hanged Man", "XIII - Death", "XIV - Temperance", "XV - The Devil",
            "XVI - The Tower", "XVII - The Star", "XVIII - The Moon", "XIX - The Sun",
            "XX - Judgement", "XXI - The World",
            "Ace of Wands", "Two of Wands", "Three of Wands", "Four of Wands", "Five of Wands",
            "Six of Wands", "Seven of Wands", "Eight of Wands", "Nine of Wands", "Ten of Wands",
            "Page of Wands", "Knight of Wands", "Queen of Wands", "King of Wands",
            "Ace of Cups", "Two of Cups", "Three of Cups", "Four of Cups", "Five of Cups",
            "Six of Cups", "Seven of Cups", "Eight of Cups", "Nine of Cups", "Ten of Cups",
            "Page of Cups", "Knight of Cups", "Queen of Cups", "King of Cups",
            "Ace of Swords", "Two of Swords", "Three of Swords", "Four of Swords", "Five of Swords",
            "Six of Swords", "Seven of Swords", "Eight of Swords", "Nine of Swords", "Ten of Swords",
            "Page of Swords", "Knight of Swords", "Queen of Swords", "King of Swords",
            "Ace of Pentacles", "Two of Pentacles", "Three of Pentacles", "Four of Pentacles",
            "Five of Pentacles", "Six of Pentacles", "Seven of Pentacles", "Eight of Pentacles",
            "Nine of Pentacles", "Ten of Pentacles", "Page of Pentacles", "Knight of Pentacles",
            "Queen of Pentacles", "King of Pentacles"
        ];

        let currentDeck = [], currentDrawnCards = [], historySpreads = [], numCardsToDraw = 1, aiChatHistory = [];

        const currentCardElement = document.getElementById('current-card');
        const cardImageFront = document.getElementById('card-image-front');
        const drawButton = document.getElementById('draw-button');
        const completeSpreadButton = document.getElementById('complete-spread-button');
        const messageBox = document.getElementById('message-box');
        const currentSpreadDisplay = document.getElementById('current-spread-display');
        const historyContainer = document.getElementById('history-container');
        const clearHistoryButton = document.getElementById('clear-history-button'); 
        const spreadTypeRadios = document.querySelectorAll('input[name="spread-type"]');
        const questionInput = document.getElementById('question-input');
        const getAiReadingButton = document.getElementById('get-ai-reading-button');
        const coiSauThemBtn = document.getElementById('coi-sau-them-btn'); 
        const bocBaiMoiBtn = document.getElementById('boc-bai-moi-btn');   
        const loadingAiResponse = document.getElementById('loading-ai-response');
        const aiCardInterpretationsContainer = document.getElementById('ai-card-interpretations-container');
        const aiCardInterpretationsRow = document.getElementById('ai-card-interpretations-row');
        const aiOverallInterpretation = document.getElementById('ai-overall-interpretation');
        const overallText = document.getElementById('overall-text');
        const aiSuggestions = document.getElementById('ai-suggestions');
        const suggestionsText = document.getElementById('suggestions-text');

        const modalBackdrop = document.getElementById('card-modal-backdrop');
        const modalCardImage = document.getElementById('modal-card-image');
        const modalCardName = document.getElementById('modal-card-name');
        const modalCloseButton = document.getElementById('modal-close-button');

        function getCardImageUrl(cardName) {
            let filename = '';
            /* [ĐÃ SỬA] Đường dẫn tuyệt đối để ổn định hơn trên Vercel */
            const path = '/assets/images/tarot/';

            if (cardName.includes(' - ')) {
                const parts = cardName.split(' - '); 
                const numberRoman = parts[0];
                const name = parts[1].replace(/ /g, ''); 
                let numStr = '';
                switch (numberRoman) {
                    case '0': numStr = '00'; break; case 'I': numStr = '01'; break; case 'II': numStr = '02'; break; case 'III': numStr = '03'; break;
                    case 'IV': numStr = '04'; break; case 'V': numStr = '05'; break; case 'VI': numStr = '06'; break; case 'VII': numStr = '07'; break;
                    case 'VIII': numStr = '08'; break; case 'IX': numStr = '09'; break; case 'X': numStr = '10'; break; case 'XI': numStr = '11'; break;
                    case 'XII': numStr = '12'; break; case 'XIII': numStr = '13'; break; case 'XIV': numStr = '14'; break; case 'XV': numStr = '15'; break;
                    case 'XVI': numStr = '16'; break; case 'XVII': numStr = '17'; break; case 'XVIII': numStr = '18'; break; case 'XIX': numStr = '19'; break;
                    case 'XX': numStr = '20'; break; case 'XXI': numStr = '21'; break; default: numStr = '00'; 
                }
                filename = `${numStr}-${name}.png`; 
            } else {
                const parts = cardName.toLowerCase().split(' '); 
                let suit = parts[parts.length - 1]; 
                let rank = parts[0]; 
                let suitCapitalized = suit.charAt(0).toUpperCase() + suit.slice(1);
                if (suit === 'pentacles') suitCapitalized = 'Pentacles';
                let numStr = '';
                switch (rank) {
                    case 'ace': numStr = '01'; break; case 'two': numStr = '02'; break; case 'three': numStr = '03'; break; case 'four': numStr = '04'; break;
                    case 'five': numStr = '05'; break; case 'six': numStr = '06'; break; case 'seven': numStr = '07'; break; case 'eight': numStr = '08'; break;
                    case 'nine': numStr = '09'; break; case 'ten': numStr = '10'; break; case 'page': numStr = '11'; break; case 'knight': numStr = '12'; break;
                    case 'queen': numStr = '13'; break; case 'king': numStr = '14'; break; default: numStr = '01';
                }
                filename = `${suitCapitalized}${numStr}.png`; 
            }
            return `${path}${filename}`;
        }

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; 
            messageBox.classList.remove('bg-red-500', 'bg-green-500', 'bg-blue-500');
            if (type === 'error') messageBox.classList.add('bg-red-500');
            else if (type === 'success') messageBox.classList.add('bg-green-500');
            else messageBox.classList.add('bg-blue-500'); 
            setTimeout(() => { messageBox.classList.remove('show'); }, 3000); 
        }

        function shuffleDeck() {
            currentDeck = [...allTarotCards]; 
            for (let i = currentDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]]; 
            }
            showMessage("Bộ bài đã được xáo trộn.", "success");
        }

        function updateCurrentCardDisplay(cardName) {
            const imageUrl = getCardImageUrl(cardName);
            cardImageFront.src = imageUrl;
            cardImageFront.alt = `Lá bài: ${cardName}`;
            currentCardElement.classList.add('drawn');
        }

        function updateCurrentSpreadDisplay() {
            currentSpreadDisplay.innerHTML = ''; 
            currentDrawnCards.forEach(cardName => {
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('current-spread-card');
                cardDiv.onclick = () => showModal(cardName);
                const img = document.createElement('img');
                img.src = getCardImageUrl(cardName);
                img.alt = cardName;
                const overlay = document.createElement('div');
                overlay.classList.add('card-name-overlay');
                overlay.textContent = cardName;
                cardDiv.appendChild(img);
                cardDiv.appendChild(overlay);
                currentSpreadDisplay.appendChild(cardDiv);
            });
        }

        function updateHistoryDisplay() {
            historyContainer.innerHTML = ''; 
            historySpreads.slice().reverse().forEach((spread, index) => {
                const spreadGroupDiv = document.createElement('div');
                spreadGroupDiv.classList.add('history-spread-group');
                spreadGroupDiv.innerHTML = `
                    <div class="history-spread-header mb-2 flex justify-between items-center text-sm">
                        <span class="font-bold text-cyan-300">Hành trình ${historySpreads.length - index}: ${spread.spreadType} lá</span>
                        <span class="text-gray-400">${spread.timestamp}</span>
                    </div>`;
                const cardsDiv = document.createElement('div');
                cardsDiv.classList.add('history-spread-cards');
                spread.cards.forEach(cardName => {
                    const cardItemDiv = document.createElement('div');
                    cardItemDiv.classList.add('history-card-item');
                    cardItemDiv.onclick = () => showModal(cardName);
                    cardItemDiv.innerHTML = `
                        <img src="${getCardImageUrl(cardName)}" alt="${cardName}">
                        <div class="card-name-overlay">${cardName}</div>`;
                    cardsDiv.appendChild(cardItemDiv);
                });
                spreadGroupDiv.appendChild(cardsDiv);
                historyContainer.appendChild(spreadGroupDiv); 
            });
            historyContainer.scrollTop = 0; 
        }

        function drawCard() {
            if (currentDrawnCards.length >= numCardsToDraw) {
                showMessage(`Bạn đã rút đủ ${numCardsToDraw} lá.`, "info");
                return;
            }
            if (currentDeck.length === 0) shuffleDeck(); 
            if (currentCardElement.classList.contains('drawn')) {
                currentCardElement.classList.remove('drawn');
                setTimeout(drawNewCard, 300); 
            } else {
                drawNewCard();
            }
        }
        
        function drawNewCard() {
            const randomIndex = Math.floor(Math.random() * currentDeck.length);
            const drawnCard = currentDeck.splice(randomIndex, 1)[0]; 
            currentDrawnCards.push(drawnCard); 
            updateCurrentCardDisplay(drawnCard); 
            updateCurrentSpreadDisplay(); 
            if (currentDrawnCards.length === numCardsToDraw) {
                drawButton.disabled = true; 
                completeSpreadButton.disabled = false; 
                getAiReadingButton.disabled = false; 
                showMessage(`Đã rút đủ ${numCardsToDraw} lá! Hãy nhập câu hỏi.`, "success");
            } else {
                drawButton.textContent = `Rút lá bài (Lá ${currentDrawnCards.length + 1} / ${numCardsToDraw})`;
            }
        }

        function completeSpread() {
            if (currentDrawnCards.length > 0) {
                historySpreads.push({
                    timestamp: new Date().toLocaleString('vi-VN'),
                    cards: [...currentDrawnCards], 
                    spreadType: numCardsToDraw
                });
                saveHistory(); 
                showMessage("Đã lưu vào lịch sử.", "success");
            }
            currentDrawnCards = []; 
            currentSpreadDisplay.innerHTML = ''; 
            clearAiResponseDisplay(); 
            questionInput.value = ''; 
            updateHistoryDisplay(); 
            resetGameVisuals(); 
            shuffleDeck(); 
        }

        function resetGameVisuals() {
            currentCardElement.classList.remove('drawn');
            cardImageFront.src = ""; 
            drawButton.textContent = "Rút một lá bài";
            drawButton.disabled = false;
            completeSpreadButton.disabled = true;
            getAiReadingButton.disabled = true; 
            coiSauThemBtn.disabled = true;       
            bocBaiMoiBtn.disabled = true;       
        }

        function clearAiResponseDisplay() {
            aiCardInterpretationsRow.innerHTML = '';
            overallText.textContent = '';
            suggestionsText.textContent = '';
            aiCardInterpretationsContainer.classList.add('hidden');
            aiOverallInterpretation.classList.add('hidden');
            aiSuggestions.classList.add('hidden');
            loadingAiResponse.classList.add('hidden');
        }

        function saveHistory() { localStorage.setItem('tarotHistory', JSON.stringify(historySpreads)); }
        function loadHistory() {
            const saved = localStorage.getItem('tarotHistory');
            if (saved) { historySpreads = JSON.parse(saved); updateHistoryDisplay(); }
        }
        function clearHistory() {
            if (confirm('Xóa toàn bộ lịch sử?')) {
                historySpreads = []; localStorage.removeItem('tarotHistory'); updateHistoryDisplay(); showMessage('Đã xóa.', 'success');
            }
        }

        function showModal(cardName) {
            modalCardImage.src = getCardImageUrl(cardName);
            modalCardImage.alt = cardName;
            modalCardName.textContent = cardName;
            const keywordsEl = document.getElementById('modal-card-keywords');
            const xuoiEl = document.getElementById('modal-card-xuoi');
            const nguocEl = document.getElementById('modal-card-nguoc');
            const container = document.querySelector('.modal-meaning-content');

            if (typeof cardMeanings !== 'undefined' && cardMeanings[cardName]) {
                keywordsEl.textContent = cardMeanings[cardName].keywords || "...";
                xuoiEl.textContent = cardMeanings[cardName].xuoi || "...";
                nguocEl.textContent = cardMeanings[cardName].nguoc || "...";
            } else {
                keywordsEl.textContent = "Đang cập nhật...";
                xuoiEl.textContent = "Dữ liệu đang được cập nhật...";
                nguocEl.textContent = "...";
            }
            if (container) container.scrollTop = 0;
            modalBackdrop.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.add('show');
                document.getElementById('card-modal-content').style.transform = 'scale(1)';
            }, 10);
        }

        function closeModal() {
            modalBackdrop.classList.remove('show');
            document.getElementById('card-modal-content').style.transform = 'scale(0.9)';
            setTimeout(() => modalBackdrop.classList.add('hidden'), 300);
        }

        async function getAiReading() { 
            if (currentDrawnCards.length !== numCardsToDraw || !questionInput.value.trim()) return showMessage("Chưa rút đủ bài hoặc chưa nhập câu hỏi.", "error");
            
            clearAiResponseDisplay(); 
            loadingAiResponse.classList.remove('hidden'); 
            getAiReadingButton.disabled = true;
            const userQuestion = questionInput.value.trim();

            // Prompt logic (Giữ nguyên logic cũ nhưng tối ưu code)
            if (aiChatHistory.length === 0) {
                 const cardsString = currentDrawnCards.join(", ");
                 const prompt = `Bạn là Tarot Reader chuyên nghiệp. Hãy giải bài Tarot: "${cardsString}". Câu hỏi: "${userQuestion}". Trả về đúng định dạng JSON: { "cardInterpretations": [{"cardName": "Tên", "interpretation": "Nội dung"}], "overallInterpretation": "Tổng quan", "nextStepsSuggestion": "Lời khuyên" }`;
                 aiChatHistory.push({ role: "user", parts: [{ text: prompt }] });
            } else {
                aiChatHistory.push({ role: "user", parts: [{ text: userQuestion }] });
            }

            try {
                const response = await fetch('/api/getReading', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: aiChatHistory, generationConfig: { responseMimeType: "application/json" } })
                });
                
                const result = await response.json();
                if (result.candidates && result.candidates[0].content) {
                    aiChatHistory.push(result.candidates[0].content);
                    const jsonText = result.candidates[0].content.parts[0].text;
                    displayAiResponse(JSON.parse(jsonText));
                    showMessage("Đã giải mã xong!", "success");
                    coiSauThemBtn.disabled = false;
                    bocBaiMoiBtn.disabled = false;
                } else {
                    throw new Error("Không có phản hồi từ AI.");
                }
            } catch (error) {
                console.error(error);
                showMessage("Lỗi kết nối vũ trụ. Thử lại sau.", "error");
                aiChatHistory.pop();
            } finally {
                loadingAiResponse.classList.add('hidden'); 
                getAiReadingButton.disabled = false;
            }
        }

        function displayAiResponse(data) {
            if (data.cardInterpretations) {
                data.cardInterpretations.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'p-3 rounded-lg shadow-md border border-[#005f7c] bg-[#030629]';
                    div.innerHTML = `<h5 class="font-bold text-cyan-300 mb-1">${card.cardName}:</h5><p class="text-sm text-gray-300">${card.interpretation}</p>`;
                    aiCardInterpretationsRow.appendChild(div);
                });
                aiCardInterpretationsContainer.classList.remove('hidden');
            }
            overallText.innerHTML = data.overallInterpretation ? data.overallInterpretation.replace(/\n/g, '<br>') : '';
            aiOverallInterpretation.classList.remove('hidden');
            suggestionsText.innerHTML = data.nextStepsSuggestion ? data.nextStepsSuggestion.replace(/\n/g, '<br>') : '';
            aiSuggestions.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            drawButton.addEventListener('click', drawCard);
            completeSpreadButton.addEventListener('click', completeSpread);
            getAiReadingButton.addEventListener('click', getAiReading); 
            clearHistoryButton.addEventListener('click', clearHistory);
            modalCloseButton.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

            spreadTypeRadios.forEach(r => r.addEventListener('change', (e) => {
                numCardsToDraw = parseInt(e.target.value);
                if (currentDrawnCards.length === 0) { resetGameVisuals(); shuffleDeck(); }
            }));
            loadHistory(); shuffleDeck(); resetGameVisuals(); 
        });
    </script>
</body>
</html>
